<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>5</storyId>
    <title>Chess Move Validation with chess.js</title>
    <status>drafted</status>
    <generatedAt>2025-01-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-5-chess-move-validation-with-chess-js.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a user,</asA>
    <iWant>I want my moves to be validated according to chess rules,</iWant>
    <soThat>so that I can only make legal moves.</soThat>
    <tasks>
- [ ] **Task 1: Install chess.js Package** (AC: 1)
  - [ ] Run `npm install chess.js` to install the package
  - [ ] Verify package is added to `package.json` dependencies
  - [ ] Verify TypeScript types are available (package includes types or @types/chess.js)
  - [ ] Test import: `import { Chess } from 'chess.js'`

- [ ] **Task 2: Create Chess Engine Wrapper** (AC: 1)
  - [ ] Create `/src/core/chess/engine.ts` file
  - [ ] Import chess.js: `import { Chess } from 'chess.js'`
  - [ ] Create `ChessEngine` class or functional wrapper
  - [ ] Initialize chess instance: `new Chess()` with initial position (FEN: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  - [ ] Export functions:
    - `validateMove(from: string, to: string, promotion?: string): boolean`
    - `makeMove(from: string, to: string, promotion?: string): MoveResult | null`
    - `getFEN(): string` - Get current board state as FEN
    - `isCheck(): boolean` - Check if current player is in check
    - `isCheckmate(): boolean` - Check if current player is checkmated
    - `isStalemate(): boolean` - Check if game is stalemate
    - `isDraw(): boolean` - Check if game is draw
    - `reset(): void` - Reset to starting position

- [ ] **Task 3: Integrate chess.js with ChessBoard Component** (AC: 1, 2)
  - [ ] Open `/src/components/Board/ChessBoard.tsx`
  - [ ] Import chess engine: `import { ChessEngine } from '@/core/chess/engine'` or functional imports
  - [ ] Initialize chess engine instance in component (use `useRef` or `useState` to persist instance)
  - [ ] Update `handlePieceDrop` function to use chess.js validation:
    - Call `validateMove(sourceSquare, targetSquare)` before accepting move
    - If valid: Call `makeMove()` to execute move
    - Get updated FEN: `getFEN()`
    - Update session store `boardState` with new FEN
    - Return `true` to allow react-chessboard to update visual board
    - If invalid: Return `false` to reject move
  - [ ] Sync chess engine state with session store `boardState` on component mount (if boardState exists)

- [ ] **Task 4: Update Session Store with Board State** (AC: 2)
  - [ ] Open `/src/stores/sessionStore.ts`
  - [ ] Ensure `setBoardState(fen: string)` action exists (from Story 3.4)
  - [ ] In ChessBoard component, call `setBoardState(updatedFEN)` after valid move
  - [ ] Ensure board state persists across component re-renders
  - [ ] Test: Board state updates correctly after each move

- [ ] **Task 5: Implement Invalid Move Error Feedback** (AC: 3)
  - [ ] Add error state to ChessBoard component: `const [moveError, setMoveError] = useState<string | null>(null)`
  - [ ] When move is invalid:
    - Set error message: `setMoveError("Invalid move")`
    - Show visual feedback (tooltip or toast notification)
    - Clear error after 2-3 seconds or on next move attempt
  - [ ] Visual feedback options:
    - Use shadcn/ui toast component: `import { useToast } from '@/components/ui/toast'`
    - Or show inline error message below board
    - Or highlight invalid move attempt (red border on target square)
  - [ ] Clear error state when valid move is made

- [ ] **Task 6: Handle Special Move Rules** (AC: 1)
  - [ ] Test en passant moves (validate and execute correctly)
  - [ ] Test castling moves (kingside and queenside)
  - [ ] Test pawn promotion (prompt user for promotion piece if needed, or auto-promote to queen)
  - [ ] Verify chess.js handles all special rules automatically
  - [ ] Document any special handling needed in Dev Notes

- [ ] **Task 7: Check/Checkmate Detection** (AC: 1)
  - [ ] After each move, check game state:
    - Call `isCheck()` to detect if player is in check
    - Call `isCheckmate()` to detect if player is checkmated
    - Call `isStalemate()` to detect stalemate
    - Call `isDraw()` to detect draw conditions
  - [ ] Store game state in session store (optional, for future match end detection in Story 3.9):
    - Add `gameStatus: 'normal' | 'check' | 'checkmate' | 'stalemate' | 'draw'` to session store
    - Update game status after each move
  - [ ] Visual feedback for check (optional, highlight king in check)

- [ ] **Task 8: Turn Management** (AC: 2)
  - [ ] Ensure chess.js tracks current turn (white/black)
  - [ ] After user makes valid move, verify turn switches to black (AI)
  - [ ] Prevent user from making moves when it's AI's turn
  - [ ] Store current turn in session store (optional, for UI display):
    - Add `currentTurn: 'white' | 'black'` to session store
    - Update after each move

- [ ] **Task 9: Testing and Verification** (AC: All)
  - [ ] Test valid moves: All piece types move correctly (pawn, knight, bishop, rook, queen, king)
  - [ ] Test invalid moves: Illegal moves are rejected (e.g., pawn moving backward, knight jumping incorrectly)
  - [ ] Test special moves: En passant, castling, pawn promotion work correctly
  - [ ] Test check detection: King in check is detected correctly
  - [ ] Test checkmate detection: Checkmate is detected correctly
  - [ ] Test board state sync: Session store `boardState` updates after each valid move
  - [ ] Test error feedback: Invalid moves show error message
  - [ ] Test turn switching: Turn switches to AI after user move
  - [ ] Test board persistence: Board state persists across component re-renders
  - [ ] Verify no console errors or warnings
  - [ ] Test edge cases: Multiple invalid moves in a row, rapid move attempts
    </tasks>
  </story>

  <acceptanceCriteria>
**AC1: Move Validation with chess.js**
Given a user attempts to make a move on the chess board
When the user clicks on a destination square
Then the system validates the move using chess.js:
- Checks if move is legal according to chess rules
- Validates piece movement patterns (pawn, knight, bishop, rook, queen, king)
- Checks for check/checkmate conditions
- Validates en passant, castling, pawn promotion rules

**AC2: Valid Move Execution**
And when move is valid:
- Move is executed on board
- Board state is updated (FEN string updated in session store)
- Captured piece (if any) is removed from board
- Turn switches to AI opponent

**AC3: Invalid Move Handling**
And when move is invalid:
- Move is rejected
- Error feedback shown (visual highlight, tooltip: "Invalid move")
- Board state remains unchanged
- User can try another move
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="5.1 Core Features (V1)" snippet="Classic Mode uses chess.js rules for move validation. The system validates moves according to chess rules, ensuring only legal moves are allowed." />
      <doc path="docs/architecture.md" title="Architecture Document" section="3. Component Responsibilities - Game Engine Layer" snippet="chess.js controls legal moves, game state, checkmate logic. The Game Engine Layer handles move validation and board state management without direct persistence interactions." />
      <doc path="docs/architecture.md" title="Architecture Document" section="3. Component Responsibilities - Session Layer" snippet="Session Layer manages current board state (FEN) in Zustand. Board state updates only after valid moves. This layer never writes to persistence directly." />
      <doc path="docs/architecture.md" title="Architecture Document" section="8. File & Folder Structure" snippet="Chess engine wrapper location: /src/core/chess/engine.ts. This follows the core chess directory structure for game engine components." />
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="7.2 Feedback Patterns - Error Feedback" snippet="Error feedback pattern: Inline validation messages below inputs or toast notifications. Invalid moves should show clear error feedback with red text or visual highlight." />
      <doc path="docs/epics.md" title="Epics Document" section="Story 3.5: Chess Move Validation with chess.js" snippet="Technical notes: Install chess.js, create engine wrapper at /src/core/chess/engine.ts, validate moves using chess.move(), update FEN in session store, handle validation in onPieceDrop callback." />
      <doc path="docs/sprint-artifacts/3-4-chess-board-display-with-react-chessboard.md" title="Story 3.4 Implementation" section="Dev Agent Record" snippet="ChessBoard component created with react-chessboard integration. Board state management via session store setBoardState action. Move validation placeholder deferred to Story 3.5." />
    </docs>
    <code>
      <artifact path="src/components/Board/ChessBoard.tsx" kind="component" symbol="ChessBoard" lines="1-139" reason="Main chess board component that needs chess.js integration. Currently has placeholder move validation in handlePieceDrop function (lines 37-53). Component uses react-chessboard with onPieceDrop callback ready for validation logic." />
      <artifact path="src/stores/sessionStore.ts" kind="store" symbol="SessionState" lines="15-81" reason="Session store with boardState field and setBoardState action. Store manages FEN string state and provides action to update board state after valid moves." />
      <artifact path="src/pages/Play.tsx" kind="page" symbol="Play" reason="Game board page that renders ChessBoard component. Page provides layout and routing for gameplay." />
    </code>
    <dependencies>
      <node>
        <package name="chess.js" version="latest" reason="Chess rules engine for move validation, game state management, and special move handling (en passant, castling, promotion)" />
        <package name="react-chessboard" version="5.8.4" reason="Visual chess board component with onPieceDrop callback for move handling" />
        <package name="zustand" version="5.0.8" reason="State management for session store (boardState, game status)" />
        <package name="react" version="19.2.0" reason="React framework for component rendering and hooks (useState, useRef)" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Chess engine wrapper must be created at /src/core/chess/engine.ts following Architecture section 8 file structure</constraint>
    <constraint>Board state (FEN) must be stored in session store boardState field, not persisted to localStorage (Architecture section 3 - Session Layer)</constraint>
    <constraint>Move validation must use chess.js - no custom chess logic allowed (Architecture section 3 - Game Engine Layer)</constraint>
    <constraint>Chess.js instance must persist across component re-renders (use useRef or useState to maintain instance)</constraint>
    <constraint>Error feedback must follow UX Design Specification section 7.2 - use shadcn/ui toast or inline error message</constraint>
    <constraint>Turn management: User plays white (bottom), AI plays black (top) - prevent moves when not user's turn</constraint>
    <constraint>Special moves (en passant, castling, promotion) must be handled by chess.js automatically - no custom logic required</constraint>
    <constraint>Game status detection (check, checkmate, stalemate, draw) is optional for this story but can be stored in session store for future use</constraint>
  </constraints>

  <interfaces>
    <interface name="ChessEngine API" kind="function signatures" signature="validateMove(from: string, to: string, promotion?: string): boolean | makeMove(from: string, to: string, promotion?: string): MoveResult | null | getFEN(): string | isCheck(): boolean | isCheckmate(): boolean | isStalemate(): boolean | isDraw(): boolean | reset(): void" path="src/core/chess/engine.ts" />
    <interface name="SessionStore API" kind="Zustand store" signature="boardState: string | setBoardState(fen: string): void" path="src/stores/sessionStore.ts" />
    <interface name="react-chessboard onPieceDrop" kind="callback function" signature="onPieceDrop({ sourceSquare, targetSquare }): boolean" path="src/components/Board/ChessBoard.tsx" />
  </interfaces>

  <tests>
    <standards>
Testing standards: Manual testing is currently used (no automated test framework set up yet). Recommended future framework: Vitest for unit tests, React Testing Library for component tests, Playwright for E2E tests (per test-design-system.md). For this story, manual testing of move validation, error feedback, and board state updates is sufficient. Test all piece types, special moves, invalid moves, and edge cases.
    </standards>
    <locations>
No test directories exist yet. Future test locations: tests/unit/ for unit tests, tests/component/ for component tests, tests/e2e/ for E2E tests (per test-design-system.md recommendations).
    </locations>
    <ideas>
      <test ac="AC1" idea="Unit test: Test validateMove() with all piece types (pawn, knight, bishop, rook, queen, king) - verify legal moves return true, illegal moves return false" />
      <test ac="AC1" idea="Unit test: Test special move validation (en passant, castling, pawn promotion) - verify chess.js handles these correctly" />
      <test ac="AC1" idea="Unit test: Test check/checkmate detection - verify isCheck() and isCheckmate() return correct values" />
      <test ac="AC2" idea="Integration test: Test makeMove() updates FEN correctly - verify getFEN() returns updated position after move" />
      <test ac="AC2" idea="Integration test: Test board state sync - verify setBoardState() is called with correct FEN after valid move" />
      <test ac="AC2" idea="Component test: Test ChessBoard component - verify onPieceDrop returns true for valid moves, false for invalid moves" />
      <test ac="AC3" idea="Component test: Test error feedback display - verify error message appears when invalid move is attempted" />
      <test ac="AC3" idea="Component test: Test error clearing - verify error clears after 2-3 seconds or on next move attempt" />
      <test ac="AC2" idea="Integration test: Test turn management - verify user cannot make moves when it's AI's turn" />
      <test ac="All" idea="E2E test: Test complete move flow - user selects piece, attempts move, validation occurs, board updates or error shown" />
    </ideas>
  </tests>
</story-context>

